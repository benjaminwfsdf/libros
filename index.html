<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Mi Biblioteca ‚Ä¢ Rosa</title>
<meta name="theme-color" content="#ff2d8b"/>
<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml;utf8,<?xml version='1.0' encoding='UTF-8'?><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'><defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop offset='0' stop-color='%23ff2d8b'/><stop offset='1' stop-color='%23ff8cc9'/></linearGradient></defs><rect rx='28' width='128' height='128' fill='url(%23g)'/><path d='M32 40h28a8 8 0 0 1 8 8v45H32zM60 40h36v53H60z' fill='white' opacity='.9'/></svg>">
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<link rel="apple-touch-icon" href="icons/icon-192.png"/>
<style>
  :root{ --bg:#12010f; --bg2:#1a0a18; --card:#241220; --muted:#ffd9ec; --txt:#fff8fb;
         --brand:#ff2d8b; --brand2:#ff8cc9; --radius:18px; --shadow:0 20px 60px rgba(0,0,0,.45); }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--txt); font:16px/1.5 system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial;
    background:
      radial-gradient(1400px 700px at 10% -10%, rgba(255,45,139,.20), transparent 60%),
      radial-gradient(900px 600px at 100% 0%, rgba(255,140,201,.18), transparent 70%),
      linear-gradient(180deg,var(--bg),#170014 40%,var(--bg2));
    overflow-x:hidden;
  }
  .sparkles{pointer-events:none; position:fixed; inset:0; z-index:0; opacity:.85;
    background-image:
      radial-gradient(2px 2px at 10% 20%, rgba(255,255,255,.35), transparent 60%),
      radial-gradient(1.5px 1.5px at 30% 80%, rgba(255,200,240,.35), transparent 60%),
      radial-gradient(2px 2px at 70% 40%, rgba(255,255,255,.35), transparent 60%),
      radial-gradient(1.5px 1.5px at 85% 70%, rgba(255,200,240,.35), transparent 60%);
    animation: twinkle 6s linear infinite;
  }
  @keyframes twinkle{0%,100%{filter:brightness(1)} 50%{filter:brightness(1.35)}}
  .wrap{position:relative; z-index:1; max-width:1200px; margin:0 auto; padding:24px 18px 88px} /* extra bottom for mobile bar */
  header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px}
  .brand{display:flex; align-items:center; gap:12px}
  .logo{width:48px;height:48px;border-radius:14px;
        background:conic-gradient(from 210deg at 70% 30%, var(--brand2), var(--brand), #ff4db0 60%, #2b0d25 80%);
        box-shadow:0 6px 22px rgba(255,45,139,.45), inset 0 0 0 1px rgba(255,255,255,.08);}
  h1{margin:0; font-weight:900; letter-spacing:.2px; font-size:clamp(1.1rem,2.4vw,1.6rem)}
  nav#topNav{display:flex; gap:8px; flex-wrap:wrap}
  .pill{border:1px solid #402038; background:#2b1425; color:#ffe3f1; padding:10px 14px; border-radius:999px; cursor:pointer}
  .pill.active{background:linear-gradient(180deg,#3b1a31,#2a1026); color:#fff; border-color:#532443; box-shadow:0 0 0 2px rgba(255,45,139,.15) inset}
  .view{display:none} .view.active{display:block}
  .panel-grid{display:grid; gap:16px; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); margin-top:16px}
  .card{background:linear-gradient(180deg,#2a1224,#1f0d1a); border:1px solid #3b1a30; border-radius:var(--radius); box-shadow:var(--shadow); padding:16px; display:flex; flex-direction:column; gap:10px; position:relative; overflow:hidden}
  .card::after{content:""; position:absolute; inset:auto -30% -30% auto; width:190px; height:190px; border-radius:50%;
    background:radial-gradient(closest-side, rgba(255,45,139,.25), transparent 70%); transform:rotate(25deg)}
  .card h3{margin:0; font-size:1.05rem} .card p{margin:0; color:var(--muted); min-height:2lh}
  .actions{display:flex; gap:8px; margin-top:auto; flex-wrap:wrap}
  .btn{appearance:none; border:0; border-radius:12px; padding:12px 16px; cursor:pointer; transition:.2s;
       background:linear-gradient(180deg,#ff4db0,#ff2d8b); color:#fff; font-weight:700; letter-spacing:.2px;
       box-shadow:0 10px 20px rgba(255,45,139,.35), inset 0 0 0 1px rgba(255,255,255,.08);}
  .btn.secondary{background:linear-gradient(180deg,#3b1a31,#2a1026); border:1px solid #4a1f3c; color:#ffd9ec}
  .btn:hover{filter:brightness(1.06)} .btn:active{transform:translateY(1px)}
  .panel{background:linear-gradient(180deg,#240e20,#1a0a18); border:1px solid #3b1a30; border-radius:var(--radius); padding:14px; box-shadow:var(--shadow); margin:16px 0 20px; display:grid; gap:12px}
  .grid-form{display:grid; gap:10px; grid-template-columns:repeat(6,1fr)} .col-2{grid-column:span 2} .col-3{grid-column:span 3} .col-6{grid-column:span 6}
  label{font-size:.9rem; color:#ffcae6; display:block; margin-bottom:6px}
  .input, select, textarea{width:100%; background:#2b1425; border:1px solid #4a1f3c; color:#fff; padding:14px 14px; border-radius:12px; outline:none; transition:.2s}
  .input:focus, select:focus, textarea:focus{border-color:#ff4db0; box-shadow:0 0 0 3px rgba(255,77,176,.2)}
  .toolbar{display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:8px 0 14px}
  .searchbar{position:relative} .searchbar input{width:min(360px,75vw)}
  .grid{display:grid; gap:14px; grid-template-columns:repeat(auto-fill,minmax(170px,1fr))}
  .bcard{position:relative; overflow:hidden; border-radius:16px; background:#2b1425; border:1px solid #45203a; box-shadow:0 10px 24px rgba(0,0,0,.35)}
  .cover{aspect-ratio:2/3; width:100%; background:#1d0c19 center/cover no-repeat}
  .badges{position:absolute; top:8px; left:8px; display:flex; gap:6px; z-index:2}
  .badge{font-size:.72rem; padding:4px 8px; border-radius:999px; background:#2d1124cc; border:1px solid #4a1f3c; color:#ffd9ec}
  .content{padding:10px 12px} .title{font-weight:800; font-size:1rem; line-height:1.25; margin:0 0 2px}
  .author{font-size:.9rem; color:#ffcae6; margin:0 0 8px}
  .meta{display:flex; gap:8px; align-items:center; justify-content:space-between}
  .iconbtn{width:42px; height:42px; border-radius:12px; background:#38172f; border:1px solid #4a1f3c; display:grid; place-items:center; cursor:pointer; color:#ffd9ec}
  .iconbtn:hover{filter:brightness(1.08)}
  .stars{display:flex; gap:2px} .stars button{background:transparent; border:0; cursor:pointer; opacity:.95; color:#ff8cc9}
  .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.6); backdrop-filter: blur(2px); z-index:50}
  .modal.active{display:flex}
  .modal-card{width:min(95vw, 680px); background:#200a1a; border:1px solid #4a1f3c; border-radius:16px; box-shadow:var(--shadow); padding:16px}
  .modal-head{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px}
  .modal-body{display:grid; grid-template-columns: 160px 1fr; gap:16px}
  .note{white-space:pre-wrap; background:#2b1425; border:1px solid #4a1f3c; padding:10px; border-radius:12px; min-height:84px; color:#fff}
  .toast{position:fixed; top:14px; right:14px; z-index:60; display:flex; flex-direction:column; gap:8px}
  .toast .t{background:#2b1425; border:1px solid #4a1f3c; color:#fff; padding:10px 14px; border-radius:12px; box-shadow:var(--shadow)}

  /* ===== Overlay esc√°ner ===== */
  .scanner-wrap{position:relative; width:100%;}
  .scanner-overlay{position:absolute; inset:0; display:grid; place-items:center; pointer-events:none;}
  .scanner-frame{width:82%; max-width:520px; aspect-ratio:1.8/1; border-radius:16px;
                 outline:2px solid rgba(255,255,255,.26); box-shadow:inset 0 0 0 2px rgba(255,255,255,.18);}
  .scanner-corners::before,.scanner-corners::after{content:""; position:absolute; width:28px; height:28px; border:3px solid #fff; opacity:.9;}
  .scanner-corners::before{ inset:auto auto 14% 8%; border-right:0; border-top:0; border-radius:0 0 0 10px;}
  .scanner-corners::after{ inset:14% 8% auto auto; border-left:0; border-bottom:0; border-radius:10px 0 0 0;}
  .scanner-text{ position:absolute; top:10%; width:100%; text-align:center; color:#fff; text-shadow:0 2px 8px rgba(0,0,0,.6); font-weight:700}
  .help-sheet{ background:#2b1425; border:1px solid #4a1f3c; border-radius:12px; padding:10px; }
  .help-head{display:flex; align-items:center; gap:8px; cursor:pointer}
  .help-body{display:none; margin-top:6px; color:#ffd9ec;}
  .help-sheet.open .help-body{display:block}

  /* ===== Bottom bar m√≥vil ===== */
  .mobilebar{
    position:fixed; bottom:0; left:0; right:0; z-index:40;
    background:linear-gradient(180deg,#2a1224,#1f0d1a);
    border-top:1px solid #3b1a30; padding:10px 12px;
    display:none; gap:8px; justify-content:space-between;
    backdrop-filter:saturate(140%) blur(6px);
  }
  .mobilebar .pill{flex:1; text-align:center; padding:12px 10px}
  .install-btn{position:fixed; right:12px; bottom:72px; z-index:41}

  @media (max-width:740px){
    .grid-form{grid-template-columns:repeat(2,1fr)}
    .col-2,.col-3,.col-6{grid-column:span 2}
    .modal-body{grid-template-columns:1fr}
    nav#topNav{display:none}
    .mobilebar{display:flex}
    .grid{grid-template-columns:repeat(2,1fr)}
    .btn,.pill{padding:14px 14px}
  }
  @media (max-width:420px){
    .grid{grid-template-columns:1fr}
    .content{padding:12px 12px}
    .iconbtn{width:46px;height:46px}
  }
</style>
</head>
<body>
<div class="sparkles" aria-hidden="true"></div>
<div class="toast" id="toast" aria-live="polite"></div>

<div class="wrap">
  <header>
    <div class="brand"><div class="logo" aria-hidden="true"></div><h1>Mi Biblioteca Rosa</h1></div>
    <nav id="topNav">
      <button class="pill active" data-route="#/panel">Panel</button>
      <button class="pill" data-route="#/add">Agregar</button>
      <button class="pill" data-route="#/library/all">Biblioteca</button>
      <button class="pill" data-route="#/library/to-read">Por leer</button>
      <button class="pill" data-route="#/library/reading">Leyendo</button>
      <button class="pill" data-route="#/library/read">Le√≠dos</button>
      <button class="pill" data-route="#/stats">Estad√≠sticas</button>
    </nav>
  </header>

  <!-- PANEL -->
  <section id="view-panel" class="view active">
    <div class="panel-grid">
      <article class="card"><h3>Agregar libro</h3><p>Escanea el ISBN o escribe los datos. La portada aparece sola.</p><div class="actions"><a class="btn" href="#/add">Ir a Agregar</a></div></article>
      <article class="card"><h3>Biblioteca</h3><p>Filtra por estado, busca y califica con estrellas.</p><div class="actions"><a class="btn" href="#/library/all">Ver todos</a><a class="btn secondary" href="#/library/to-read">Por leer</a></div></article>
      <article class="card"><h3>Estad√≠sticas</h3><p>Conteos por estado y promedio ‚≠ê.</p><div class="actions"><a class="btn" href="#/stats">Ver stats</a></div></article>
      <article class="card"><h3>Respaldo</h3><p>Exporta/Importa tu biblioteca en JSON.</p>
        <div class="actions">
          <button class="btn" id="exportBtnPanel">Exportar</button>
          <label class="btn secondary">Importar<input id="importFilePanel" type="file" accept="application/json" hidden></label>
          <button class="btn secondary" id="resetApp">Reset app</button>
        </div>
      </article>
    </div>
  </section>

  <!-- AGREGAR -->
  <section id="view-add" class="view">
    <div class="panel">
      <form id="bookForm">
        <div class="grid-form">
          <div class="col-3"><label for="title">T√≠tulo</label><input id="title" class="input" required placeholder="Ej: El nombre del viento"/></div>
          <div class="col-3"><label for="author">Autor</label><input id="author" class="input" required placeholder="Ej: Patrick Rothfuss"/></div>
          <div class="col-2">
            <label for="isbn">ISBN (puedes escanear)</label>
            <div style="display:flex; gap:8px">
              <input id="isbn" class="input" inputmode="numeric" placeholder="978... (13 d√≠gitos)" style="flex:1"/>
              <button type="button" class="btn secondary" id="scanBtn">Escanear</button>
            </div>
            <small style="color:#ffcae6;opacity:.9">Tip: abre la URL <strong>HTTPS</strong> para usar la c√°mara.</small>
          </div>
          <div class="col-2"><label for="status">Estado</label>
            <select id="status" class="input"><option value="to-read">Por leer</option><option value="reading">Leyendo</option><option value="read">Le√≠do</option></select>
          </div>
          <div class="col-2"><label for="rating">Calificaci√≥n (si le√≠do)</label>
            <select id="rating" class="input"><option value="0">Sin calificar</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select>
          </div>
          <div class="col-6"><label for="notes">Notas (opcional)</label><textarea id="notes" rows="2" class="input" placeholder="Cita o comentario..."></textarea></div>
          <div class="col-6" style="display:flex; gap:8px; justify-content:flex-end"><button class="btn" id="addBtn">Guardar libro</button></div>
        </div>
      </form>
    </div>
  </section>

  <!-- BIBLIOTECA -->
  <section id="view-library" class="view">
    <div class="toolbar">
      <div class="searchbar">
        <input id="q" class="input" placeholder="Buscar por t√≠tulo o autor..."/>
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);opacity:.65">
          <path d="M21 21l-4.35-4.35M10.5 18A7.5 7.5 0 1 1 10.5 3a7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
      </div>
      <div class="pill" data-route="#/library/all">Todos</div>
      <div class="pill" data-route="#/library/to-read">Por leer</div>
      <div class="pill" data-route="#/library/reading">Leyendo</div>
      <div class="pill" data-route="#/library/read">Le√≠dos</div>
      <button class="pill" id="exportBtn">Exportar</button>
      <label class="pill">Importar<input id="importFile" type="file" accept="application/json" hidden></label>
    </div>
    <div id="grid" class="grid" aria-live="polite"></div>
  </section>

  <!-- ESTAD√çSTICAS -->
  <section id="view-stats" class="view">
    <div class="panel"><div id="statsArea"></div></div>
  </section>
</div>

<!-- BOTTOM BAR M√ìVIL -->
<div class="mobilebar" id="mobilebar">
  <button class="pill" data-route="#/panel">Panel</button>
  <button class="pill" data-route="#/add">Agregar</button>
  <button class="pill" data-route="#/library/all">Biblioteca</button>
  <button class="pill" data-route="#/stats">Stats</button>
</div>

<!-- BOT√ìN INSTALAR PWA -->
<button class="btn install-btn" id="installBtn" style="display:none">Instalar app</button>

<!-- MODAL DETALLE -->
<div class="modal" id="modal">
  <div class="modal-card">
    <div class="modal-head"><h3 id="modalTitle">Detalle</h3>
      <button class="iconbtn" id="closeModal" title="Cerrar"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M18 6 6 18" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg></button>
    </div>
    <div class="modal-body">
      <div class="cover" id="modalCover"></div>
      <div>
        <div class="field"><strong>Autor:</strong> <span id="modalAuthor"></span></div>
        <div class="field"><strong>ISBN:</strong> <span id="modalIsbn"></span></div>
        <div class="field">
          <strong>Estado:</strong>
          <select id="modalStatusSel" class="input" style="width:auto; display:inline-block; min-width:140px; margin-left:6px">
            <option value="to-read">Por leer</option>
            <option value="reading">Leyendo</option>
            <option value="read">Le√≠do</option>
          </select>
        </div>
        <div class="field"><strong>Calificaci√≥n:</strong> <span id="modalRating"></span> ‚≠ê</div>
        <div class="field"><label for="modalNotes">Notas</label><textarea id="modalNotes" class="note" rows="5" placeholder="Escribe tus notas..."></textarea></div>
      </div>
    </div>
    <div class="modal-foot" style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px">
      <button class="btn secondary" id="saveNotes">Guardar</button>
      <button class="btn" id="markRead">Marcar como le√≠do</button>
    </div>
  </div>
</div>

<!-- MODAL ESC√ÅNER -->
<div class="modal" id="scanModal">
  <div class="modal-card" style="width:min(95vw,520px)">
    <div class="modal-head"><h3>Escanear ISBN</h3>
      <div style="display:flex; gap:8px; align-items:center">
        <button class="btn secondary" id="torchBtn" title="Linterna">Linterna</button>
        <button class="iconbtn" id="closeScan" title="Cerrar"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M18 6 6 18" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg></button>
      </div>
    </div>
    <div class="modal-body" style="grid-template-columns:1fr">
      <div class="scanner-wrap">
        <video id="video" autoplay muted playsinline webkit-playsinline style="width:100%; border-radius:12px; background:#000"></video>
        <div class="scanner-overlay">
          <div class="scanner-text">Escanea el c√≥digo de barras</div>
          <div class="scanner-frame scanner-corners"></div>
        </div>
      </div>

      <div class="help-sheet" id="helpSheet" style="margin-top:10px">
        <div class="help-head">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 8v4m0 4h.01M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
          <strong>¬øC√≥mo usar el esc√°ner?</strong>
        </div>
        <div class="help-body">
          <ul style="margin:8px 0 0 18px">
            <li>Apunta al c√≥digo de barras de la contraportada.</li>
            <li>Activa la <em>linterna</em> si hay poca luz (si tu tel√©fono lo permite).</li>
            <li>Tambi√©n puedes escribir el c√≥digo manualmente.</li>
          </ul>
        </div>
      </div>
    </div>
    <div class="modal-foot" style="display:flex; justify-content:space-between; gap:8px; margin-top:10px">
      <button class="btn secondary" id="flipCam">Cambiar c√°mara</button>
      <button class="btn" id="stopScan">Detener</button>
    </div>
  </div>
</div>

<!-- ZXing (fallback de escaneo) -->
<script src="https://unpkg.com/@zxing/library@0.20.0"></script>
<script>
/* ===== CONFIG ===== */
const SHEETS_URL = "https://script.google.com/macros/library/d/10b7lnMs_Q69F8O4CKNekwxwRZfxxsMvFVvjwsxWYhKhJg0wIcdXxphp3/2"; // opcional
const KEY = "book-tracker-v1";

/* ===== Utils ===== */
const $ = s => document.querySelector(s); const $$ = s => Array.from(document.querySelectorAll(s));
let state = { books: load(), route: location.hash || "#/panel", viewFilter: "all", q:"", selectedId:null };
function load(){ try{return JSON.parse(localStorage.getItem(KEY))||[]}catch{return[]} }
function persist(){ localStorage.setItem(KEY, JSON.stringify(state.books)); }
function uid(){ return Math.random().toString(36).slice(2,9)+Date.now().toString(36).slice(2); }
function normalize(s){ return (s||"").toString().normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().trim(); }
function escapeHtml(s){ return (s||"").replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
function nextStatus(s){ return s==="to-read"?"reading":s==="reading"?"read":"to-read"; }
function toast(msg){ const c=$("#toast"); const el=document.createElement("div"); el.className="t"; el.textContent=msg; c.appendChild(el); setTimeout(()=>{el.style.opacity=.15},1700); setTimeout(()=>el.remove(),2000); }

/* ===== Router ===== */
function go(route){ state.route=route; location.hash=route; renderRoute(); }
function renderRoute(){
  $$("#topNav .pill, #mobilebar .pill").forEach(b=>b.classList.toggle("active", b.dataset.route===state.route));
  $$(".view").forEach(v=>v.classList.remove("active"));
  if(state.route.startsWith("#/panel")) $("#view-panel").classList.add("active");
  else if(state.route.startsWith("#/add")) $("#view-add").classList.add("active");
  else if(state.route.startsWith("#/library")){ $("#view-library").classList.add("active"); const seg=state.route.split("/"); state.viewFilter=seg[2]||"all"; renderLibrary(); }
  else if(state.route.startsWith("#/stats")){ $("#view-stats").classList.add("active"); renderStats(); }
}
window.addEventListener("hashchange", ()=>{ state.route=location.hash||"#/panel"; renderRoute(); });
document.addEventListener("click",(e)=>{ const r=e.target.closest("[data-route]"); if(r){e.preventDefault(); go(r.dataset.route);} });

/* ===== Portadas ===== */
async function imgExists(url){ return new Promise(res=>{ const i=new Image(); i.onload=()=>res(true); i.onerror=()=>res(false); i.src=url; }); }
function olCoverByIsbn(isbn, size="L"){ return `https://covers.openlibrary.org/b/isbn/${isbn}-${size}.jpg`; }
function olCoverById(id, size="L"){ return `https://covers.openlibrary.org/b/id/${id}-${size}.jpg`; }
async function fetchOpenLibraryByIsbn(isbn){ const clean=(isbn||"").replace(/[^0-9Xx]/g,""); if(!clean) return null;
  const url=olCoverByIsbn(clean); if(await imgExists(url)) return {cover:url};
  try{ const r=await fetch(`https://openlibrary.org/api/books?bibkeys=ISBN:${clean}&format=json&jscmd=data`); const data=await r.json(); const k=data[`ISBN:${clean}`]; if(k?.cover?.large) return {cover:k.cover.large}; }catch{}
  return null;}
async function fetchOpenLibraryByQuery(title, author){ try{ const qs=new URLSearchParams({q:`${title||""} ${author||""}`.trim(), limit:"1"}); const r=await fetch(`https://openlibrary.org/search.json?${qs}`); const j=await r.json(); const d=j.docs?.[0]; if(d?.cover_i) return {cover:olCoverById(d.cover_i)}; }catch{} return null;}
async function fetchGoogleBooks({title, author, isbn}){ try{ let q=""; if(isbn) q=`isbn:${isbn}`; else{ const t=title?`intitle:${JSON.stringify(title).slice(1,-1)}`:""; const a=author?`+inauthor:${JSON.stringify(author).slice(1,-1)}`:""; q=`${t}${a}`||"book"; }
  const r=await fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(q)}&maxResults=1`); const j=await r.json(); const item=j.items?.[0]; const img=item?.volumeInfo?.imageLinks;
  if(img){ return {cover:(img.thumbnail||img.smallThumbnail||"").replace("http://","https://").replace("&edge=curl","")}; } }catch{} return null;}
async function fetchCover({title, author, isbn}){ if(isbn){ const a=await fetchOpenLibraryByIsbn(isbn); if(a?.cover) return a.cover; }
  const b=await fetchOpenLibraryByQuery(title, author); if(b?.cover) return b.cover;
  const c=await fetchGoogleBooks({title, author, isbn}); if(c?.cover) return c.cover;
  return "data:image/svg+xml;utf8,"+encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='400' height='600'><defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop offset='0' stop-color='#2b1425'/><stop offset='1' stop-color='#ff2d8b'/></linearGradient></defs><rect width='100%' height='100%' fill='url(#g)'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='#ffd9ec' font-family='Arial' font-size='22'>Sin portada</text></svg>`); }

/* ===== CRUD + UI ===== */
function addBook(b){ state.books.push(b); persist(); toast("Libro guardado ‚úî"); }
function updateBook(id, patch){ const i=state.books.findIndex(x=>x.id===id); if(i>=0){ state.books[i]={...state.books[i],...patch}; persist(); } }
function removeBook(id){ state.books=state.books.filter(x=>x.id!==id); persist(); renderLibrary(); toast("Eliminado"); }

function filledStar(){ return `<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="m12 17.27 6.18 3.73-1.64-7.03L21 9.24l-7.19-.62L12 2 10.19 8.62 3 9.24l4.46 4.73L5.82 21z"/></svg>`; }
function emptyStar(){ return `<svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="m12 17.27 6.18 3.73-1.64-7.03L21 9.24l-7.19-.62L12 2 10.19 8.62 3 9.24l4.46 4.73L5.82 21z" stroke="currentColor" stroke-width="1.4"/></svg>`; }
function cardHtml(b){
  const stars=[1,2,3,4,5].map(i=>`<button class="star" data-v="${i}" title="${i}">${i<=Number(b.rating||0)?filledStar():emptyStar()}</button>`).join("");
  const badge=b.status==="to-read"?"Por leer":b.status==="reading"?"Leyendo":"Le√≠do";
  return `<article class="bcard" data-id="${b.id}">
    <div class="badges"><span class="badge">${badge}</span></div>
    <div class="cover" style="background-image:url('${b.cover||""}')"></div>
    <div class="content">
      <h4 class="title">${escapeHtml(b.title)}</h4>
      <div class="author">${escapeHtml(b.author||"")}</div>
      <div class="meta">
        <div class="stars">${stars}</div>
        <div style="display:flex; gap:6px">
          <button class="iconbtn open" title="Abrir">+</button>
          <button class="iconbtn status" title="Cambiar estado">‚Üª</button>
          <button class="iconbtn markread" title="Marcar le√≠do">‚úì</button>
          <button class="iconbtn del" title="Eliminar">üóë</button>
        </div>
      </div>
    </div>
  </article>`;}
function renderLibrary(){
  const grid=$("#grid"); const qn=normalize(state.q);
  const list=state.books.filter(b=> (state.viewFilter==="all"||b.status===state.viewFilter) && (!qn || normalize(b.title).includes(qn)||normalize(b.author).includes(qn)));
  grid.innerHTML=list.map(cardHtml).join("")||`<p style="opacity:.85;color:#ffd9ec">No hay libros aqu√≠ a√∫n ‚ú®</p>`;
  $$("#grid [data-id]").forEach(el=>{
    const id=el.dataset.id;
    el.querySelector(".del")?.addEventListener("click",()=>removeBook(id));
    el.querySelector(".open")?.addEventListener("click",()=>openModal(id));
    el.querySelectorAll(".star").forEach(btn=>btn.addEventListener("click",()=>{updateBook(id,{rating:Number(btn.dataset.v),status:"read"}); renderLibrary();}));
    el.querySelector(".markread")?.addEventListener("click",()=>{updateBook(id,{status:"read"}); renderLibrary();});
    el.querySelector(".status")?.addEventListener("click",()=>{const next=nextStatus(state.books.find(x=>x.id===id)?.status); updateBook(id,{status:next}); renderLibrary();});
  });
}

/* Modal detalle */
function openModal(id){
  state.selectedId=id; const b=state.books.find(x=>x.id===id);
  $("#modalTitle").textContent=b.title; $("#modalAuthor").textContent=b.author||"‚Äî"; $("#modalIsbn").textContent=b.isbn||"‚Äî";
  $("#modalRating").textContent=b.rating||0; $("#modalNotes").value=b.notes||"";
  $("#modalCover").style.backgroundImage=`url('${b.cover||""}')`;
  $("#modalStatusSel").value=b.status||"to-read";
  $("#modal").classList.add("active");
}
$("#closeModal").addEventListener("click",()=>$("#modal").classList.remove("active"));
$("#saveNotes").addEventListener("click",()=>{ const id=state.selectedId; if(!id) return; updateBook(id,{notes:$("#modalNotes").value}); $("#modal").classList.remove("active"); toast("Notas guardadas"); });
$("#markRead").addEventListener("click",()=>{ const id=state.selectedId; if(!id) return; const b=state.books.find(x=>x.id===id); updateBook(id,{status:"read",rating:b.rating||5}); $("#modal").classList.remove("active"); if(state.route.startsWith("#/library")) renderLibrary(); toast("Marcado como le√≠do"); });

// select de estado en modal
$("#modalStatusSel").addEventListener("change",(e)=>{
  const id=state.selectedId; if(!id) return;
  updateBook(id,{status:e.target.value}); toast("Estado actualizado");
  if(state.route.startsWith("#/library")) renderLibrary();
});
// autosave notas (debounce)
let notesTimer=null;
$("#modalNotes").addEventListener("input", ()=>{
  const id=state.selectedId; if(!id) return;
  clearTimeout(notesTimer);
  notesTimer=setTimeout(()=>{ updateBook(id,{notes:$("#modalNotes").value}); toast("Notas guardadas"); }, 550);
});

/* Export/Import/Reset */
$("#exportBtnPanel").addEventListener("click",exportJson); $("#importFilePanel").addEventListener("change",importJson);
$("#exportBtn").addEventListener("click",exportJson); $("#importFile").addEventListener("change",importJson);
$("#resetApp").addEventListener("click",()=>{ if(confirm("¬øBorrar TODOS los libros en este dispositivo?")){ localStorage.removeItem(KEY); location.reload(); } });
function exportJson(){ const blob=new Blob([JSON.stringify(state.books,null,2)],{type:"application/json"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="mi_biblioteca.json"; document.body.appendChild(a); a.click(); a.remove(); }
function importJson(e){ const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const arr=JSON.parse(r.result); if(Array.isArray(arr)){ state.books=arr.map(x=>({id:x.id||uid(), title:String(x.title||""), author:String(x.author||""), isbn:x.isbn||"", status:["to-read","reading","read"].includes(x.status)?x.status:"to-read", rating:Number(x.rating||0), notes:x.notes||"", cover:x.cover||""})); persist(); renderRoute(); toast("Importado ‚úî"); } else alert("JSON inv√°lido"); }catch{ alert("No se pudo importar el JSON"); } }; r.readAsText(f); }

/* Stats */
function renderStats(){ const area=$("#statsArea"); const total=state.books.length;
  const st={ "to-read":state.books.filter(b=>b.status==="to-read").length, "reading":state.books.filter(b=>b.status==="reading").length, "read":state.books.filter(b=>b.status==="read").length };
  const rated=state.books.filter(b=>Number(b.rating)>0); const avg=rated.length?(rated.reduce((s,b)=>s+Number(b.rating),0)/rated.length).toFixed(2):"‚Äî";
  area.innerHTML=`<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px">
    <div class="card"><h3>Total</h3><p style="font-size:1.8rem;margin:.2rem 0">${total}</p></div>
    <div class="card"><h3>Por leer</h3><p style="font-size:1.8rem;margin:.2rem 0">${st["to-read"]}</p></div>
    <div class="card"><h3>Leyendo</h3><p style="font-size:1.8rem;margin:.2rem 0">${st["reading"]}</p></div>
    <div class="card"><h3>Le√≠dos</h3><p style="font-size:1.8rem;margin:.2rem 0">${st["read"]}</p></div>
    <div class="card"><h3>Promedio ‚≠ê</h3><p style="font-size:1.8rem;margin:.2rem 0">${avg}</p></div></div>`; }

/* ===== Esc√°ner (trasera + torch + BarcodeDetector -> ZXing) ===== */
let codeReader=null, currentStream=null, devices=[], currentIndex=-1, imageCapture=null, torchOn=false;
const CAM_KEY='book-tracker-lastCameraId';
const scanModal=$("#scanModal"), videoEl=$("#video"), torchBtn=$("#torchBtn");

// ayuda plegable
const helpSheet=$("#helpSheet");
helpSheet.querySelector(".help-head").addEventListener("click",()=>helpSheet.classList.toggle("open"));

$("#scanBtn")?.addEventListener("click", openScan);
$("#closeScan")?.addEventListener("click", stopScan);
$("#stopScan")?.addEventListener("click", stopScan);
$("#flipCam")?.addEventListener("click", async ()=>{
  if(!devices.length) return;
  currentIndex=(currentIndex+1)%devices.length;
  await startCameraByDeviceId(devices[currentIndex].deviceId);
  await startDecoding();
  try{ localStorage.setItem(CAM_KEY, devices[currentIndex].deviceId); }catch{}
});

// Linterna (cuando soporte)
torchBtn.addEventListener("click", async ()=>{
  if(!imageCapture){ toast("Linterna no disponible"); return; }
  try{
    torchOn=!torchOn;
    const track=currentStream.getVideoTracks()[0];
    await track.applyConstraints({ advanced: [{ torch: torchOn }] });
    torchBtn.textContent = torchOn ? "Linterna (ON)" : "Linterna";
  }catch{ toast("No se pudo activar la linterna"); }
});

async function openScan(){
  if(!(location.protocol==='https:' || location.hostname==='localhost')){ alert('Usa una URL HTTPS para abrir la c√°mara.'); return; }
  if(!navigator.mediaDevices?.getUserMedia){ alert('Tu navegador no soporta c√°mara.'); return; }

  scanModal.classList.add("active");
  try{
    const warmup = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { exact:'environment' } } })
      .catch(()=> navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' } }))
      .catch(()=> navigator.mediaDevices.getUserMedia({ video:true }));
    if(warmup){ attachStream(warmup); currentStream=warmup; }

    devices = (await navigator.mediaDevices.enumerateDevices()).filter(d=>d.kind==='videoinput');

    const saved = (()=>{ try{ return localStorage.getItem(CAM_KEY)||'' }catch{ return '' }})();
    let preferId = saved && devices.some(d=>d.deviceId===saved) ? saved : null;
    if(!preferId){
      const back = devices.find(d=>/back|rear|environment|traser|tr√°s/i.test(d.label));
      preferId = back?.deviceId || (devices[devices.length-1]||devices[0])?.deviceId;
    }

    await startCameraByDeviceId(preferId);
    await startDecoding();
  }catch(err){
    console.warn('openScan error:', err);
    alert('No se pudo abrir la c√°mara. Revisa permisos del sitio.\n'+(err.message||'')); stopScan();
  }
}

function attachStream(stream){
  videoEl.setAttribute('playsinline','true');
  videoEl.setAttribute('autoplay','true');
  videoEl.setAttribute('muted','true');
  videoEl.setAttribute('webkit-playsinline','true');
  videoEl.muted=true;
  videoEl.srcObject=stream;
  videoEl.play?.();
  try{
    const track=stream.getVideoTracks()[0];
    imageCapture = ('ImageCapture' in window) ? new ImageCapture(track) : null;
  }catch{ imageCapture=null; }
}

async function startCameraByDeviceId(deviceId){
  stopCamera();
  const constraints = deviceId ? { video:{ deviceId:{ exact:deviceId } } } : { video:{ facingMode:'environment' } };
  const stream = await navigator.mediaDevices.getUserMedia(constraints).catch(async ()=>{
    try{ return await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' } }); }catch{}
    return await navigator.mediaDevices.getUserMedia({ video:true });
  });
  currentStream=stream; attachStream(stream);
  currentIndex = Math.max(0, devices.findIndex(d=>d.deviceId===deviceId));
  torchOn=false; torchBtn.textContent="Linterna";
}

let stopDetector=null;
async function startDecoding(){
  if('BarcodeDetector' in window){
    const formats = ['ean_13','isbn_13','ean_8','upc_a','code_128'];
    let detector; try{ detector=new BarcodeDetector({formats}); }catch{ detector=new BarcodeDetector(); }
    let running=true; stopDetector=()=>{ running=false; };

    const loop = async ()=>{
      if(!running) return;
      try{
        const codes = await detector.detect(videoEl);
        if(codes && codes.length){
          const raw = (codes[0].rawValue||"");
          const isbn = normalizeIsbnCandidate(raw);
          if(isbn){ await onIsbnDetected(isbn); return; }
        }
      }catch(e){
        console.warn('BarcodeDetector fall√≥, se usar√° ZXing', e);
        running=false; await startZXing(); return;
      }
      requestAnimationFrame(loop);
    };
    loop();
  }else{
    await startZXing();
  }
}

async function startZXing(){
  if(!codeReader){
    const hints = new Map();
    hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [ZXing.BarcodeFormat.EAN_13, ZXing.BarcodeFormat.ISBN, ZXing.BarcodeFormat.EAN_8, ZXing.BarcodeFormat.UPC_A]);
    codeReader = new ZXing.BrowserMultiFormatReader(hints);
  }
  try{ codeReader.reset(); }catch{}
  await codeReader.decodeFromVideoElementContinuously(videoEl, async (result, err)=>{
    if(result){
      const isbn = normalizeIsbnCandidate(String(result.getText()||""));
      if(isbn){ await onIsbnDetected(isbn); }
    }
  });
}

/* ===== ISBN helpers ===== */
function normalizeIsbnCandidate(s){
  const digits = String(s||"").replace(/\D/g,"");
  if(digits.length < 12) return null;
  const v = digits.length>13 ? digits.slice(0,13) : digits;
  if(!(v.startsWith("978")||v.startsWith("979"))) return null;
  return isValidIsbn13(v) ? v : null;
}
function isValidIsbn13(v){
  if(!/^\d{13}$/.test(v)) return false;
  let sum=0; for(let i=0;i<12;i++){ sum += (i%2?3:1)*Number(v[i]); }
  return ((10-(sum%10))%10) === Number(v[12]);
}

let handling=false;
async function onIsbnDetected(isbn){
  if(handling) return; handling=true;
  try{
    await autorrellenarPorISBN(isbn);
    toast("ISBN detectado ‚úî");
    stopScan();
  }catch(e){
    console.warn('autorrellenar error:',e); alert('Se ley√≥ el c√≥digo, pero no se pudo completar.');
  }finally{ handling=false; }
}

function stopScan(){
  stopCamera();
  try{ stopDetector?.(); }catch{}
  try{ codeReader?.reset(); }catch{}
  scanModal.classList.remove("active");
}
function stopCamera(){
  try{ if(currentStream){ currentStream.getTracks().forEach(t=>t.stop()); currentStream=null; } videoEl.srcObject=null; videoEl.pause?.(); }catch{}
}

/* ===== Autorrellenar por ISBN ===== */
async function autorrellenarPorISBN(isbn){
  $("#isbn").value=isbn;
  const meta=await lookupByIsbn(isbn);
  if(meta){
    if(meta.title) $("#title").value=meta.title;
    if(meta.author) $("#author").value=meta.author;
    if(meta.publisher || meta.year || meta.pages){
      const extra = `Editorial: ${meta.publisher||"‚Äî"}${meta.year? " ‚Ä¢ A√±o: "+meta.year:""}${meta.pages? " ‚Ä¢ P√°ginas: "+meta.pages:""}`;
      if(!$("#notes").value) $("#notes").value = extra;
    }
    const cover=meta.cover||await fetchCover({title:meta.title,author:meta.author,isbn});
    $("#isbn").dataset.coverPreview=cover||"";
  }else{
    alert("No se encontraron datos para ese ISBN.");
  }
}

/* === Lookup OpenLibrary + Google Books === */
async function lookupByIsbn(isbn){
  const clean = (isbn||"").replace(/[^0-9Xx]/g,"");
  if(!clean) return null;

  // 1) OpenLibrary /isbn/{isbn}.json
  try{
    const r = await fetch(`https://openlibrary.org/isbn/${clean}.json`);
    if(r.ok){
      const d = await r.json();
      let author="";
      if(d.authors && d.authors[0]?.key){
        try{ const ra = await fetch(`https://openlibrary.org${d.authors[0].key}.json`);
             if(ra.ok){ const ja=await ra.json(); author=ja.name||""; } }catch{}
      }
      return {
        title: d.title||"", author,
        cover: `https://covers.openlibrary.org/b/isbn/${clean}-L.jpg`,
        publisher: d.publishers?.[0]||"", year: d.publish_date||"", pages: d.number_of_pages||""
      };
    }
  }catch{}

  // 2) OpenLibrary API books?bibkeys
  try{
    const r=await fetch(`https://openlibrary.org/api/books?bibkeys=ISBN:${clean}&format=json&jscmd=data`);
    const j=await r.json(); const k=j[`ISBN:${clean}`];
    if(k){ 
      return {
        title:k.title||"",
        author:k.authors?.[0]?.name||"",
        cover:k.cover?.large||`https://covers.openlibrary.org/b/isbn/${clean}-L.jpg`,
        publisher:k.publishers?.[0]?.name||"",
        year:k.publish_date||"", pages:k.number_of_pages||""
      }; 
    }
  }catch{}

  // 3) Google Books
  try{
    const r=await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${clean}&maxResults=1&printType=books`);
    const j=await r.json(); const it=j.items?.[0];
    if(it){
      const vi=it.volumeInfo||{}, img=vi.imageLinks||{};
      return {
        title: vi.title||"", author: (vi.authors?.[0])||"",
        cover: (img.thumbnail||img.smallThumbnail||"").replace("http://","https://"),
        publisher: vi.publisher||"", year: vi.publishedDate||"", pages: vi.pageCount||""
      };
    }
  }catch{}
  return null;
}

/* Guardar */
$("#addBtn").addEventListener("click",async (e)=>{ e.preventDefault();
  const title=$("#title").value.trim(); const author=$("#author").value.trim(); const isbn=$("#isbn").value.trim();
  const status=$("#status").value; const rating=Number($("#rating").value||0); const notes=$("#notes").value.trim();
  if(!title||!author){ alert("T√≠tulo y autor son obligatorios"); return; }
  const cover=$("#isbn").dataset.coverPreview||await fetchCover({title,author,isbn});
  const book={id:uid(), title, author, isbn, status, rating, notes, cover};
  addBook(book);
  sendToSheets(book).then(()=>toast("Enviado a Sheets ‚úî")).catch(()=>toast("Guardado local (no se pudo enviar a Sheets)"));
  $("#bookForm").reset(); delete $("#isbn").dataset.coverPreview; go("#/library/all");
});

/* Enviar a Sheets (opcional) */
async function sendToSheets(book){
  if(!SHEETS_URL || SHEETS_URL.includes("script.google.com/macros/library")) return;
  const form=new URLSearchParams();
  form.set('action','add');
  form.set('book', JSON.stringify({ ...book, createdAt:new Date().toISOString() }));
  await fetch(SHEETS_URL,{ method:'POST', mode:'no-cors', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: form.toString() });
}

/* B√∫squeda y navegaci√≥n */
$("#q").addEventListener("input", e=>{ state.q=e.target.value||""; renderLibrary(); });
renderRoute();

/* ===== PWA: registrar SW e instalar ===== */
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>navigator.serviceWorker.register('./service-worker.js'));
}

let deferredPrompt=null;
window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault();
  deferredPrompt = e;
  $("#installBtn").style.display="block";
});
$("#installBtn").addEventListener('click', async ()=>{
  if(!deferredPrompt) return;
  deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice;
  if(outcome==='accepted') toast("Instalada ‚úî");
  $("#installBtn").style.display="none";
  deferredPrompt=null;
});
</script>
</body>
</html>
